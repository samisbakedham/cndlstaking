{"version":3,"file":"widgetManager.js","sourceRoot":"","sources":["../../src/widget/widgetManager.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,iCAA4B;AAG5B,sDAAqD;AACrD,oCAAmC;AACnC,sDAA6D;AAE7D,6EAA6E;AAC7E,IAAM,UAAU,GAAG,OAAO,CAAC,GAAG,CAAC,iBAAiB,IAAI,0BAA0B,CAAC;AAC/E,IAAM,kBAAkB,GAAG,kCAAkC,CAAC;AAC9D,IAAM,mBAAmB,GAAG,yBAAyB,CAAC;AACtD,IAAM,sBAAsB,GAAG,sBAAsB,CAAC;AAEtD,SAAgB,iBAAiB;IAC/B,IAAI,QAAQ,CAAC,sBAAsB,CAAC,mBAAmB,CAAC,CAAC,MAAM,EAAE;QAC/D,OAAO,CAAC,IAAI,CACV,sJAAsJ,CACvJ,CAAC;KACH;AACH,CAAC;AAND,8CAMC;AAED;IASE,uBAAoB,aAAyB,EAAU,qBAAiC;QAApE,kBAAa,GAAb,aAAa,CAAY;QAAU,0BAAqB,GAArB,qBAAqB,CAAY;QANhF,eAAU,GAAG,UAAU,CAAC;QACxB,qBAAgB,GAAyE,cAAO,CAAC,CAAC;QAClG,sBAAiB,GAAe,cAAO,CAAC,CAAC;QAEzC,qBAAgB,GAA2B,cAAO,CAAC,CAAC;QAG1D,mCAAoB,EAAE,CAAC;QACvB,IAAI,aAAa,CAAC,OAAO,EAAE;YACzB,OAAO,CAAC,IAAI,CAAC,4DAA4D,CAAC,CAAC;YAC3E,IAAI,CAAC,UAAU,GAAG,kBAAkB,CAAC;SACtC;QACD,aAAa,CAAC,gCAAgC,EAAE,CAAC;IACnD,CAAC;IAED,kBAAkB;IACZ,iCAAS,GAAf;;;;;;6BACM,CAAC,IAAI,CAAC,cAAc,EAApB,wBAAoB;wBACtB,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE;4BACvB,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,WAAW,EAAE,CAAC;yBACzC;wBACD,KAAA,IAAI,CAAA;wBAAkB,qBAAM,IAAI,CAAC,aAAa,EAAA;;wBAA9C,GAAK,cAAc,GAAG,SAAwB,CAAC;;4BAEjD,sBAAO,IAAI,CAAC,cAAc,EAAC;;;;KAC5B;IAED,uCAAe,GAAf,UAAgB,KAAa;QAC3B,IAAI,CAAC,aAAa,CAAC,YAAY,GAAG,KAAK,CAAC;IAC1C,CAAC;IAED,6EAA6E;IAE7E,0CAAkB,GAAlB,UAAmB,QAA8E;QAC/F,IAAI,CAAC,gBAAgB,GAAG,QAAQ,CAAC;IACnC,CAAC;IAED,2CAAmB,GAAnB,UAAoB,QAAoB;QACtC,IAAI,CAAC,iBAAiB,GAAG,QAAQ,CAAC;IACpC,CAAC;IAED,wDAAgC,GAAhC,UAAiC,QAAyC;QACxE,IAAI,CAAC,8BAA8B,GAAG,QAAQ,CAAC;IACjD,CAAC;IAED,0CAAkB,GAAlB,UAAmB,QAAgC;QACjD,IAAI,CAAC,gBAAgB,GAAG,QAAQ,CAAC;IACnC,CAAC;IAED,0EAA0E;IAEpE,kCAAU,GAAhB;;;;;4BAC+B,qBAAM,IAAI,CAAC,SAAS,EAAE,EAAA;;wBAA7C,mBAAmB,GAAG,CAAC,SAAsB,CAAC,CAAC,aAAa;wBAClE,sBAAO,mBAAmB,CAAC,UAAU,CAAC,IAAI,CAAC,aAAa,CAAC,EAAC;;;;KAC3D;IAEK,uCAAe,GAArB,UAAsB,UAAkB;;;;;4BACT,qBAAM,IAAI,CAAC,SAAS,EAAE,EAAA;;wBAA7C,mBAAmB,GAAG,CAAC,SAAsB,CAAC,CAAC,aAAa;wBAClE,sBAAO,mBAAmB,CAAC,eAAe,CAAC,UAAU,CAAC,EAAC;;;;KACxD;IAEK,oCAAY,GAAlB,UAAmB,SAAiB;;;;;4BACL,qBAAM,IAAI,CAAC,SAAS,EAAE,EAAA;;wBAA7C,mBAAmB,GAAG,CAAC,SAAsB,CAAC,CAAC,aAAa;wBAClE,sBAAO,mBAAmB,CAAC,YAAY,CAAC,SAAS,EAAE,IAAI,CAAC,aAAa,CAAC,EAAC;;;;KACxE;IAEK,8BAAM,GAAZ;;;;;4BAC+B,qBAAM,IAAI,CAAC,SAAS,EAAE,EAAA;;wBAA7C,mBAAmB,GAAG,CAAC,SAAsB,CAAC,CAAC,aAAa;wBAClE,sBAAO,mBAAmB,CAAC,MAAM,EAAE,EAAC;;;;KACrC;IAEK,4CAAoB,GAA1B,UAA2B,IAAiC,EAAE,IAAyB;QAA5D,qBAAA,EAAA,yBAAiC;QAAE,qBAAA,EAAA,iBAAyB;;;;;4BACxD,qBAAM,IAAI,CAAC,SAAS,EAAE,EAAA;;wBAA7C,mBAAmB,GAAG,CAAC,SAAsB,CAAC,CAAC,aAAa;wBAClE,sBAAO,mBAAmB,CAAC,oBAAoB,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,CAAC,aAAa,CAAC,EAAC;;;;KACjF;IAEK,oCAAY,GAAlB,UAAmB,oBAA4B;;;;;4BAChB,qBAAM,IAAI,CAAC,SAAS,EAAE,EAAA;;wBAA7C,mBAAmB,GAAG,CAAC,SAAsB,CAAC,CAAC,aAAa;wBAClE,sBAAO,mBAAmB,CAAC,YAAY,CAAC,oBAAoB,EAAE,IAAI,CAAC,aAAa,CAAC,EAAC;;;;KACnF;IAEK,kCAAU,GAAhB;;;;;4BAC+B,qBAAM,IAAI,CAAC,SAAS,EAAE,EAAA;;wBAA7C,mBAAmB,GAAG,CAAC,SAAsB,CAAC,CAAC,aAAa;wBAClE,sBAAO,mBAAmB,CAAC,UAAU,EAAE,EAAC;;;;KACzC;IAEK,8CAAsB,GAA5B,UAA6B,MAAyB;;;;;4BACvB,qBAAM,IAAI,CAAC,SAAS,EAAE,EAAA;;wBAA7C,mBAAmB,GAAG,CAAC,SAAsB,CAAC,CAAC,aAAa;wBAClE,sBAAO,mBAAmB,CAAC,sBAAsB,CAAC,MAAM,EAAE,IAAI,CAAC,aAAa,CAAC,EAAC;;;;KAC/E;IAEK,yCAAiB,GAAvB,UAAwB,IAAgC;QAAhC,qBAAA,EAAA,wBAAgC;;;;;4BACzB,qBAAM,IAAI,CAAC,SAAS,EAAE,EAAA;;wBAA7C,mBAAmB,GAAG,CAAC,SAAsB,CAAC,CAAC,aAAa;wBAClE,sBAAO,mBAAmB,CAAC,iBAAiB,CAAC,IAAI,EAAE,IAAI,CAAC,aAAa,CAAC,EAAC;;;;KACxE;IAEK,qCAAa,GAAnB,UAAoB,MAA4B;;;;;4BACjB,qBAAM,IAAI,CAAC,SAAS,EAAE,EAAA;;wBAA7C,mBAAmB,GAAG,CAAC,SAAsB,CAAC,CAAC,aAAa;wBAClE,sBAAO,mBAAmB,CAAC,aAAa,CAAC,MAAM,EAAE,IAAI,CAAC,aAAa,CAAC,EAAC;;;;KACtE;IAED,mBAAmB;IAEJ,8CAAgC,GAA/C;QACE,IAAI,QAAQ,CAAC,sBAAsB,CAAC,sBAAsB,CAAC,CAAC,MAAM,EAAE;YAClE,OAAO,CAAC,IAAI,CACV,iJAAiJ,CAClJ,CAAC;SACH;IACH,CAAC;IAEa,mCAAW,GAAzB;;;;;4BACE,qBAAM,2BAAY,EAAE,EAAA;;wBAApB,SAAoB,CAAC;wBAEf,KAAK,GAAG,QAAQ,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC;wBAC9C,KAAK,CAAC,SAAS,GAAG,eAAM,CAAC;wBAEnB,SAAS,GAAG,QAAQ,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;wBAChD,SAAS,CAAC,SAAS,GAAG,sBAAsB,CAAC;wBAEvC,WAAW,GAAG,QAAQ,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;wBAClD,WAAW,CAAC,EAAE,GAAG,sBAAoB,IAAI,CAAC,GAAG,EAAI,CAAC;wBAClD,WAAW,CAAC,SAAS,GAAG,mBAAmB,CAAC;wBAE5C,SAAS,CAAC,WAAW,CAAC,WAAW,CAAC,CAAC;wBACnC,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,SAAS,CAAC,CAAC;wBACrC,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;wBAE3B,UAAU,GAAG,gBAAM,CAAC,cAAc,CAAqB;4BAC3D,GAAG,EAAE,IAAI,CAAC,UAAU;4BACpB,QAAQ,EAAE,QAAQ,CAAC,cAAc,CAAC,WAAW,CAAC,EAAE,CAAE;4BAClD,OAAO,EAAE;gCACP,SAAS,EAAE,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC;gCACrC,aAAa,EAAE,aAAa,CAAC,cAAc,CAAC,IAAI,CAAC,IAAI,CAAC;gCACtD,OAAO,EAAE,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC;gCACjC,QAAQ,EAAE,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC;gCACnC,qBAAqB,EAAE,IAAI,CAAC,sBAAsB,CAAC,IAAI,CAAC,IAAI,CAAC;gCAC7D,wBAAwB,EAAE,IAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,IAAI,CAAC;gCAClE,OAAO,EAAE,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC;6BAClC;yBACF,CAAC,CAAC;wBAEmB,qBAAM,UAAU,CAAC,OAAO,EAAA;;wBAAxC,aAAa,GAAG,SAAwB;wBAC9C,aAAa,CAAC,YAAY,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;wBAC/C,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,QAAQ,GAAG,UAAU,CAAC;wBAC9C,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,MAAM,GAAG,MAAM,CAAC;wBACxC,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK,GAAG,MAAM,CAAC;wBACvC,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,MAAM,GAAG,eAAe,CAAC;wBAEjD,sBAAO,EAAE,aAAa,eAAA,EAAE,WAAW,aAAA,EAAE,EAAC;;;;KACvC;IAEa,kCAAU,GAAxB,UAAyB,MAAc;;;;;4BAChB,qBAAM,IAAI,CAAC,SAAS,EAAE,EAAA;;wBAArC,WAAW,GAAG,CAAC,SAAsB,CAAC,CAAC,WAAW;wBACxD,WAAW,CAAC,KAAK,CAAC,MAAM,GAAM,MAAM,OAAI,CAAC;;;;;KAC1C;IAEc,4BAAc,GAA7B;QACE,IAAM,IAAI,GAAG,QAAQ,CAAC,oBAAoB,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC;QACtD,IAAM,KAAK,GAAG,MAAM,CAAC,UAAU,IAAI,QAAQ,CAAC,eAAe,CAAC,WAAW,IAAI,IAAI,CAAC,WAAW,CAAC;QAC5F,IAAM,MAAM,GAAG,MAAM,CAAC,WAAW,IAAI,QAAQ,CAAC,eAAe,CAAC,YAAY,IAAI,IAAI,CAAC,YAAY,CAAC;QAChG,OAAO,EAAE,KAAK,OAAA,EAAE,MAAM,QAAA,EAAE,CAAC;IAC3B,CAAC;IAEO,gCAAQ,GAAhB,UAAiB,aAAqB,EAAE,KAAc,EAAE,UAAmB;QACzE,IAAI,IAAI,CAAC,gBAAgB,EAAE;YACzB,IAAI,CAAC,gBAAgB,CAAC,aAAa,EAAE,KAAK,EAAE,UAAU,CAAC,CAAC;SACzD;IACH,CAAC;IAEO,iCAAS,GAAjB;QACE,IAAI,CAAC,qBAAqB,EAAE,CAAC;QAC7B,IAAI,IAAI,CAAC,iBAAiB,EAAE;YAC1B,IAAI,CAAC,iBAAiB,EAAE,CAAC;SAC1B;IACH,CAAC;IAEO,8CAAsB,GAA9B,UAA+B,aAAqB;QAClD,IAAI,IAAI,CAAC,8BAA8B,EAAE;YACvC,IAAI,CAAC,8BAA8B,CAAC,aAAa,CAAC,CAAC;SACpD;IACH,CAAC;IAEO,gDAAwB,GAAhC;QACE,OAAO,CAAC,CAAC,IAAI,CAAC,8BAA8B,CAAC;IAC/C,CAAC;IAEO,gCAAQ,GAAhB,UAAiB,KAAY;QAC3B,IAAI,IAAI,CAAC,gBAAgB,EAAE;YACzB,IAAI,CAAC,gBAAgB,CAAC,KAAK,CAAC,CAAC;SAC9B;IACH,CAAC;IACH,oBAAC;AAAD,CAAC,AAlMD,IAkMC","sourcesContent":["import Penpal from 'penpal';\nimport { ISDKConfig, IConnectionMethods, IWidget, BTCSignTxSDKInput, IPurchaseERC20Params } from '../interfaces';\n\nimport { onWindowLoad } from '../utils/onWindowLoad';\nimport { styles } from '../styles';\nimport { validateSecureOrigin } from '../utils/secureOrigin';\n\n// Create a .env file to override the default WIDGET_URL when running locally\nconst WIDGET_URL = process.env.PORTIS_WIDGET_URL || 'https://widget.portis.io';\nconst STAGING_WIDGET_URL = 'https://widget-staging.portis.io';\nconst PORTIS_IFRAME_CLASS = 'por_portis-widget-frame';\nconst PORTIS_CONTAINER_CLASS = 'por_portis-container';\n\nexport function windowLoadHandler() {\n  if (document.getElementsByClassName(PORTIS_IFRAME_CLASS).length) {\n    console.warn(\n      'Portis script was already loaded. This might cause unexpected behavior. If loading with a <script> tag, please make sure that you only load it once.',\n    );\n  }\n}\n\nexport default class WidgetManager {\n  private widgetPromise?: Promise<IWidget>;\n  private widgetInstance?: IWidget;\n  private _widgetUrl = WIDGET_URL;\n  private _onLoginCallback: (walletAddress: string, email?: string, reputation?: string) => void = () => {};\n  private _onLogoutCallback: () => void = () => {};\n  private _onActiveWalletChangedCallback?: (walletAddress: string) => void;\n  private _onErrorCallback: (error: Error) => void = () => {};\n\n  constructor(private _widgetConfig: ISDKConfig, private _clearProviderSession: () => void) {\n    validateSecureOrigin();\n    if (_widgetConfig.staging) {\n      console.warn('Please note: you are using the Portis STAGING environment.');\n      this._widgetUrl = STAGING_WIDGET_URL;\n    }\n    WidgetManager._checkIfWidgetAlreadyInitialized();\n  }\n\n  // async singleton\n  async getWidget() {\n    if (!this.widgetInstance) {\n      if (!this.widgetPromise) {\n        this.widgetPromise = this._initWidget();\n      }\n      this.widgetInstance = await this.widgetPromise;\n    }\n    return this.widgetInstance;\n  }\n\n  setDefaultEmail(email: string) {\n    this._widgetConfig.defaultEmail = email;\n  }\n\n  // Population by the dev of SDK callbacks that might be invoked by the widget\n\n  setOnLoginCallback(callback: (walletAddress: string, email?: string, reputation?: string) => void) {\n    this._onLoginCallback = callback;\n  }\n\n  setOnLogoutCallback(callback: () => void) {\n    this._onLogoutCallback = callback;\n  }\n\n  setOnActiveWalletChangedCallback(callback: (walletAddress: string) => void) {\n    this._onActiveWalletChangedCallback = callback;\n  }\n\n  setOnErrorCallback(callback: (error: Error) => void) {\n    this._onErrorCallback = callback;\n  }\n\n  // SDK methods that could be invoked by the user and handled by the widget\n\n  async showPortis() {\n    const widgetCommunication = (await this.getWidget()).communication;\n    return widgetCommunication.showPortis(this._widgetConfig);\n  }\n\n  async getCampaignInfo(campaignId: string) {\n    const widgetCommunication = (await this.getWidget()).communication;\n    return widgetCommunication.getCampaignInfo(campaignId);\n  }\n\n  async claimVoucher(voucherId: string) {\n    const widgetCommunication = (await this.getWidget()).communication;\n    return widgetCommunication.claimVoucher(voucherId, this._widgetConfig);\n  }\n\n  async logout() {\n    const widgetCommunication = (await this.getWidget()).communication;\n    return widgetCommunication.logout();\n  }\n\n  async getExtendedPublicKey(path: string = \"m/44'/60'/0'/0/0\", coin: string = 'Ethereum') {\n    const widgetCommunication = (await this.getWidget()).communication;\n    return widgetCommunication.getExtendedPublicKey(path, coin, this._widgetConfig);\n  }\n\n  async importWallet(mnemonicOrPrivateKey: string) {\n    const widgetCommunication = (await this.getWidget()).communication;\n    return widgetCommunication.importWallet(mnemonicOrPrivateKey, this._widgetConfig);\n  }\n\n  async isLoggedIn() {\n    const widgetCommunication = (await this.getWidget()).communication;\n    return widgetCommunication.isLoggedIn();\n  }\n\n  async signBitcoinTransaction(params: BTCSignTxSDKInput) {\n    const widgetCommunication = (await this.getWidget()).communication;\n    return widgetCommunication.signBitcoinTransaction(params, this._widgetConfig);\n  }\n\n  async showBitcoinWallet(path: string = \"m/49'/0'/0'/0/0\") {\n    const widgetCommunication = (await this.getWidget()).communication;\n    return widgetCommunication.showBitcoinWallet(path, this._widgetConfig);\n  }\n\n  async purchaseERC20(params: IPurchaseERC20Params) {\n    const widgetCommunication = (await this.getWidget()).communication;\n    return widgetCommunication.purchaseERC20(params, this._widgetConfig);\n  }\n\n  // internal methods\n\n  private static _checkIfWidgetAlreadyInitialized() {\n    if (document.getElementsByClassName(PORTIS_CONTAINER_CLASS).length) {\n      console.warn(\n        'An instance of Portis was already initialized. This is probably a mistake. Make sure that you use the same Portis instance throughout your app.',\n      );\n    }\n  }\n\n  private async _initWidget(): Promise<IWidget> {\n    await onWindowLoad();\n\n    const style = document.createElement('style');\n    style.innerHTML = styles;\n\n    const container = document.createElement('div');\n    container.className = PORTIS_CONTAINER_CLASS;\n\n    const widgetFrame = document.createElement('div');\n    widgetFrame.id = `portis-container-${Date.now()}`;\n    widgetFrame.className = PORTIS_IFRAME_CLASS;\n\n    container.appendChild(widgetFrame);\n    document.body.appendChild(container);\n    document.head.appendChild(style);\n\n    const connection = Penpal.connectToChild<IConnectionMethods>({\n      url: this._widgetUrl,\n      appendTo: document.getElementById(widgetFrame.id)!,\n      methods: {\n        setHeight: this._setHeight.bind(this),\n        getWindowSize: WidgetManager._getWindowSize.bind(this),\n        onLogin: this._onLogin.bind(this),\n        onLogout: this._onLogout.bind(this),\n        onActiveWalletChanged: this._onActiveWalletChanged.bind(this),\n        hasOnActiveWalletChanged: this.hasOnActiveWalletChanged.bind(this),\n        onError: this._onError.bind(this),\n      },\n    });\n\n    const communication = await connection.promise;\n    communication.setSdkConfig(this._widgetConfig);\n    connection.iframe.style.position = 'absolute';\n    connection.iframe.style.height = '100%';\n    connection.iframe.style.width = '100%';\n    connection.iframe.style.border = '0 transparent';\n\n    return { communication, widgetFrame };\n  }\n\n  private async _setHeight(height: number) {\n    const widgetFrame = (await this.getWidget()).widgetFrame;\n    widgetFrame.style.height = `${height}px`;\n  }\n\n  private static _getWindowSize() {\n    const body = document.getElementsByTagName('body')[0];\n    const width = window.innerWidth || document.documentElement.clientWidth || body.clientWidth;\n    const height = window.innerHeight || document.documentElement.clientHeight || body.clientHeight;\n    return { width, height };\n  }\n\n  private _onLogin(walletAddress: string, email?: string, reputation?: string) {\n    if (this._onLoginCallback) {\n      this._onLoginCallback(walletAddress, email, reputation);\n    }\n  }\n\n  private _onLogout() {\n    this._clearProviderSession();\n    if (this._onLogoutCallback) {\n      this._onLogoutCallback();\n    }\n  }\n\n  private _onActiveWalletChanged(walletAddress: string) {\n    if (this._onActiveWalletChangedCallback) {\n      this._onActiveWalletChangedCallback(walletAddress);\n    }\n  }\n\n  private hasOnActiveWalletChanged(): boolean {\n    return !!this._onActiveWalletChangedCallback;\n  }\n\n  private _onError(error: Error) {\n    if (this._onErrorCallback) {\n      this._onErrorCallback(error);\n    }\n  }\n}\n"]}